import nmap
from json_parser import *

TCP = 'tcp'
UDP = 'udp'


ip_file = open('ip_list.txt', 'r')

ip_addresses = []

for line in ip_file:
	ip = line.split('\n')[0].split('#')[0].split(' ')[0]
	if ip is not "":
		ip_addresses.append(ip)

ip_file.close()
print(ip_addresses)

json_data = json_object()
nm = nmap.PortScanner()

for ip in ip_addresses:

	print("Scanning " + str(ip))
	nm.scan(ip)
	try:
		json_data.add_host(nm[ip])
		protocols = nm[ip].all_protocols()

		#for protocol in protocols:
		#	print(nm[ip][protocol].keys())

		if TCP in protocols:
			TCP_ports = nm[ip][TCP].keys()
			for port in TCP_ports:
				state = nm[ip][TCP][port]['state']
				name = nm[ip][TCP][port]['name']
				product = nm[ip][TCP][port]['product']
				print("port: " + str(port) + ", state: " + str(state) + ", name: " + str(name) + ", product: " + str(product))
				
				#@Todo call exploit code:
				


	except KeyError:
		print("Host " + str(ip) + " is not up.")

	
save_json(json_data.data, "save.json")


#print("Parsing json:")
#json_data_loaded = parse_json("save.json")
#print(json_data_loaded.data)

